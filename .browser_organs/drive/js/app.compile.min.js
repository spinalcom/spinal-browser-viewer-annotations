angular.module('app.route',['ngRoute']),angular.module('app.services',[]),angular.module('app.directives',[]),angular.module('app.controllers',[]),angular.module('app.spinalcom',['settings','ngMaterial']),angular.module('SpinalApp',['ngAnimate','ngMaterial','app.directives','app.route','jsTree.directive','app.sidebar','app.FileExplorer','app.services','app.controllers','ngMdIcons','settings','app.spinalcom']).run(['$rootScope','$location','authService',function(a,b,c){let d=c.get_user();a.$on('$routeChangeStart',function(a,e){e.$$route.authenticate&&!c.is_Connected()&&c.login(d.username,d.password).then(function(){},function(){b.path('/login')})})}]).config(['$mdThemingProvider',function(a){a.theme('altTheme').primaryPalette('grey',{default:'200'}).accentPalette('grey',{default:'700'}).dark(),a.theme('default').dark(),a.setDefaultTheme('altTheme'),a.theme('error-toast'),a.alwaysWatchTheme(!0)}]).run(['$templateCache','$http',function(a,b){let c=(c,d)=>{b.get(c).then((b)=>{a.put(d,b.data)},()=>{console.log('Cannot load the file '+c)})},d=[{uri:'app/templates/sideBar.html',name:'sideBar.html'},{uri:'app/templates/inspector.html',name:'inspector.html'},{uri:'app/templates/FileExplorer.html',name:'FileExplorer.html'}];for(var e=0;e<d.length;e++)c(d[e].uri,d[e].name)}]);
angular.module('settings',[]).constant('config',{main_path:'/',spinalhub_url:'127.0.0.1',spinalhub_port:'8888',spinalhub_user:'168'});
angular.module("app.route").config(["$routeProvider","$locationProvider",function(a){a.when("/home",{templateUrl:"app/templates/main.html",authenticate:!0,controller:"mainCtrl"}).when("/login",{templateUrl:"app/templates/login.html",authenticate:!1,controller:"loginCtrl"}).otherwise({redirectTo:"/home"})}]);
angular.module('app.directives').directive('navbar',[function(){return{restrict:'E',templateUrl:'app/templates/navbar.html',controller:'navbarCtrl'}}]).directive('menuGlayout',['goldenLayoutService','$timeout',function(a){return{restrict:'E',scope:{layoutInfo:'=info'},replace:!0,template:'<li ng-repeat="layout in layoutInfo"  id="{{layout.id}}"><a >{{layout.name}}</a></li>',link:(b)=>{a.wait_ready().then(()=>{let c=(a,b)=>()=>{a.createChild(b.cfg)};for(var d=0;d<b.layoutInfo.length;d++){let e=b.layoutInfo[d];a.createDragSource($('#'+e.id)[0],e.cfg),$('#'+e.id).click(c(a,e))}})}}}]).directive('ngRightClick',['$parse',function(a){return function(b,c,d){var e=a(d.ngRightClick);c.bind('contextmenu',function(a){b.$apply(function(){a.preventDefault(),e(b,{$event:a})})})}}]);
var ngJSTree=angular.module('jsTree.directive',[]);ngJSTree.directive('jsTree',['$http',function(a){var b={},c={restrict:'EA',fetchResource:function(b,c){return a.get(b).then(function(a){c&&c(a.data)})},managePlugins:function(c,d,f,a){if(f.treePlugins){if(a.plugins=f.treePlugins.split(','),a.core=a.core||{},a.core.check_callback=a.core.check_callback||!0,0<=a.plugins.indexOf('state')&&(a.state=a.state||{},a.state.key=f.treeStateKey),0<=a.plugins.indexOf('search')){var e=!1;'ng-tree-search'!==d.next().attr('class')&&d.after('<input type="text" placeholder="Search Tree" class="ng-tree-search"/>').next().on('keyup',function(a){e&&clearTimeout(e),e=setTimeout(function(){b.jstree(!0).search(a.target.value)},250)})}0<=a.plugins.indexOf('checkbox')&&(a.checkbox=a.checkbox||{},a.checkbox.keep_selected_style=!1),0<=a.plugins.indexOf('contextmenu')&&f.treeContextmenu&&(a.contextmenu=a.contextmenu||{},'undefined'!=typeof f.disableselectContextmenu&&(a.contextmenu.select_node=!1),a.contextmenu.items=void 0==f.treeContextmenuaction?function(a){return'function'==typeof c[f.treeContextmenu]?c[f.treeContextmenu](a):c[f.treeContextmenu]}:function(a){return c.$eval(f.treeContextmenuaction)(a)}),0<=a.plugins.indexOf('types')&&f.treeTypes&&(a.types=c[f.treeTypes],console.log(a)),0<=a.plugins.indexOf('dnd')&&f.treeDnd&&(a.dnd=c[f.treeDnd],console.log(a))}return a},manageEvents:function(c,d,e){if(e.treeEvents)for(var a=e.treeEvents.split(';'),f=0;f<a.length;f++)if(0<a[f].length){var g=a[f].split(':')[0];0>g.indexOf('.')&&(g+='.jstree');var h=a[f].split(':')[1];b.on(g,c[h])}},manageBinds:function(c,d,e){if(e.treeBinds)for(var a=e.treeBinds.split(';'),f=0;f<a.length;f++)if(0<a[f].length){var g=a[f].split(':')[0],h=a[f].split(':')[1];b.on(g,c[h])}},link:function(b,d,e){$(function(){var a={};a.core={},e.treeCore&&(a.core=$.extend(a.core,b[e.treeCore])),e.treeData=e.treeData?e.treeData.toLowerCase():'',e.treeSrc=e.treeSrc?e.treeSrc.toLowerCase():'','html'==e.treeData?c.fetchResource(e.treeSrc,function(f){d.html(f),c.init(b,d,e,a)}):'json'==e.treeData?c.fetchResource(e.treeSrc,function(f){a.core.data=f,c.init(b,d,e,a)}):'scope'==e.treeData?(b.$watch(e.treeModel,function(f){f&&(a.core.data=b[e.treeModel],$(d).jstree('destroy'),c.init(b,d,e,a))},!0),a.core.data=b[e.treeModel],c.init(b,d,e,a)):e.treeAjax&&(a.core.data={url:e.treeAjax,data:function(a){return{id:'#'==a.id?1:a.id}}},c.init(b,d,e,a))})},init:function(d,f,e,a){c.managePlugins(d,f,e,a),b=$(f).jstree(a),c.manageEvents(d,f,e),c.manageBinds(d,f,e)}};return c}]);
angular.module('app.directives').directive('dragDrop',function(){return{scope:{fileObj:'=fileObj',events:'=dragEvents'},link:function(a,b){let c=[];if(b.attr('draggable','true'),a.events){let d=(a,b)=>(c)=>b.events[a](c,b.fileObj);for(let e in a.events)if(a.events.hasOwnProperty(e)){let f={fn:d(e,a),key:e};c.push(f),b.on(e,f.fn)}a.$on('$destroy',()=>{for(var a=0;a<c.length;a++)b.off(c[a].key,c[a].fn)})}}}}).directive('folderDrop',function(){return{scope:{events:'=folderdropEvents'},link:function(a,b){let c=[];if(a.events){let d=(b,c)=>(d)=>a.events[b](d,c);for(let e in a.events)if(a.events.hasOwnProperty(e)){let a={fn:d(e,b),key:e};c.push(a),b.on(e,a.fn)}a.$on('$destroy',()=>{for(var a=0;a<c.length;a++)b.off(c[a].key,c[a].fn)})}}}});
angular.module('app.directives').factory('spinalInspectUID',[function(){let a=0,b={uid:0,get_uid:()=>(a=b.uid,++b.uid,a),get_last_uid:()=>a,elem:{}};return b.tooltip=d3.select('body').append('div').attr('class','inspect-tooltip').style('opacity',1e-6),b}]).directive('spinalInspect',['spinalInspectUID',function(a){return{restrict:'EA',link:function(b,c){let d=a.get_uid(),e=$('<div class="spinal-inspector-container" id="spinalinspect_'+d+'"></div><div class="spinal-inspect-btn-grp"><button class="btn btn-primary fa fa-bullseye" id="spinalinspect_btn_centerroot_'+d+'"></button></div>');a.elem[d]=e,$(c).append(e)}}}]);
angular.module('app.spinalcom').factory('ngSpinalCore',['$q',function(a){var b={};return b.conn=0,b.connect=function(a){b.conn=spinalCore.connect(a)},b.store=function(c,d){var e=a.defer();return spinalCore.store(b.conn,c,d,function(a){e.resolve(a)},function(){e.reject()}),e.promise},b.load=function(c){var d=a.defer();return spinalCore.load(b.conn,c,function(a){d.resolve(a)},function(){d.reject()}),d.promise},b.load_type=function(a,c,d){spinalCore.load_type(b.conn,a,function(a){c(a)},function(){d(model)})},b.load_right=function(c){var d=a.defer();return spinalCore.load_right(b.conn,c,function(a){d.resolve(a)},function(){d.reject()}),d.promise},b.share_model=function(a,c,d,e){return spinalCore.share_model(b.conn,a,c,d,e)},b}]);
angular.module('app.spinalcom').factory('spinalModelDictionary',['$q','ngSpinalCore','config','authService',function(a,b,c,d){function e(a){for(var b=0;b<j.length;b++)j[b].reject(a)}function f(a){for(var b=0;b<j.length;b++)j[b].resolve(a)}let g={model:0,users:0},h=!1,j=[];return g.init=()=>d.wait_connect().then(()=>{var c=a.defer();if(0!=g.users)c.resolve(g.model);else if(j.push(c),1===j.length){let a=d.get_user();b.load('/__users__/'+a.username).then((a)=>(g.model=a,b.load('/etc/users')),()=>{let b='not able to load : /__users__/'+a.username;console.error(b),e(b)}).then((a)=>{g.users=a,h=!1,f(g.model)},()=>{let a='not able to load : /etc/users';console.error(a),e(a)})}return c.promise},()=>{let a='not able to load : /__users__/'+user.username;console.error(a),e(a)}),g}]);
angular.module('app.spinalcom').service('spinalFileSystem',['$q','spinalModelDictionary','$rootScope','$timeout','goldenLayoutService',function(a,b,c,d,e){this.current_dir=0,this.model=0,this.id=1,this.folderExplorer_dir={};let f={};return this.curr_window=0,this.emit_subcriber=(a,b)=>{let c=f[a];if(c)for(var d=0;d<c.length;d++)c[d]&&c[d](b)},this.subcribe=(a,b)=>{let c=f[a];return c||(f[a]=[],c=f[a]),c.push(b),()=>{let a=c.indexOf(b);-1!==a&&(c[a]=null)}},this.unsubcribe=(a,b)=>{let c=f[a],d=c.indexOf(b);-1!==d&&(c[d]=null)},this.init=()=>b.init().then((a)=>{0==this.model&&(this.model=a,this.current_dir=a,this.model.bind(()=>{this.emit_subcriber('SPINAL_FS_ONCHANGE')}))},()=>{}),this.load_dir=(b)=>{let c=a.defer();return b.load((a)=>{a.bind(()=>{this.emit_subcriber('SPINAL_FS_ONCHANGE')},!1),c.resolve(a)},()=>{c.reject()}),c.promise},this.deferGetFolderJson_rec=(b,c,d,e,f,g,h)=>{let i=a.defer();return setTimeout(()=>{i.resolve(this.getFolderJson_rec(c,d,e,f,g,h))},100),i.promise},this.getFolderJson_rec=(b,c,d=[],e='home',f='#',g=!0)=>{let h;var j=[];if(FileSystem._tmp_objects[c._server_id])return this.deferGetFolderJson_rec(j,b,c,d,e,f,g);for(var k in b){let a=b[k];if(a.model==c._server_id&&a.text==e&&a.parent==f){h=a;break}}h||(h={model:c._server_id,id:this.id,parent:f,text:e,state:{opened:g}},this.id++,(!0==g||'undefined'!=typeof b[h.id]&&!0==b[h.id].state.opened)&&(h.state.opened=!0)),d.push(h),b[h.id]=h,this.folderExplorer_dir[h.id]=h;let l=(a,b,c,d)=>(e)=>this.getFolderJson_rec(a,e,b,c.name.get(),d.id,!1);for(var m=0;m<c.length;m++){let a=c[m];'Directory'==a._info.model_type.get()&&j.push(this.load_dir(a).then(l(b,d,a,h)))}return a.all(j).then(()=>({tree:d,all_dir:b}))},this.onChangeNodeTree=(a,b)=>{a[b.node.original.id].state=b.node.state,this.folderExplorer_dir[b.node.original.id].state=b.node.state},this.onbdlclick=()=>{},this.openFolder=(a,b)=>{this.curr_window&&FileSystem._objects[b.original.model]&&this.curr_window.change_curr_dir(FileSystem._objects[b.original.model],this.create_path_with_node(b))},this.openFolderInNewLayer=(a,b)=>{e.createChild({isClosable:!0,title:'File Explorer',type:'component',componentName:'SpinalHome',componentState:{template:'FileExplorer.html',module:'app.FileExplorer',controller:'FileExplorerCtrl'}}),d(()=>{this.curr_window&&FileSystem._objects[b.original.model]&&this.curr_window.change_curr_dir(FileSystem._objects[b.original.model],this.create_path_with_node(b))})},this.newFolder=(a,b,c)=>{let d=FileSystem._objects[b.original.model];if(d){let a=c,b=a.replace(/\([\d]*\)/g,''),e=0;for(;d.has(a);)a=b+'('+e+')',e++;d.add_file(a,new Directory)}},this.FileExplorer_focus=(a)=>{this.curr_window=a},this.get_node_by_id=(a)=>{for(var b in this.folderExplorer_dir)if(this.folderExplorer_dir[b].id==a)return this.folderExplorer_dir[b];return 0},this.create_path_with_node=(a)=>{let b=[],c=Array.from(a.parents).reverse();for(var d=0;d<c.length;d++){let a=c[d];if('#'==a)continue;let e=this.get_node_by_id(a);e&&b.push({name:e.text,_server_id:e.model})}return b.push({name:a.text,_server_id:a.model}),b},this.select_node=(a,b)=>{this.curr_window&&FileSystem._objects[b.node.original.model]&&this.curr_window.change_curr_dir(FileSystem._objects[b.node.original.model],this.create_path_with_node(b.node))},this.deleteFolder=(a,b)=>{console.log('delete folder '+b.original.text);let c=FileSystem._objects[b.original.model];if(c){let e=a[b.original.parent];if(FileSystem._objects[e.model]){let a=FileSystem._objects[e.model];for(var d=0;d<a.length;d++)if(a[d]._ptr.data.value==c._server_id&&b.original.text==a[d].name.get()){a.remove_ref(a[d]);break}}}},this.getFolderFiles=(b)=>this.init().then(()=>{b.curr_dir||(b.curr_dir=this.model,b.fs_path.push({name:'home',_server_id:this.model._server_id}));let c=(c)=>{let d=a.defer(),e=(a,c)=>{if(FileSystem._tmp_objects[c._server_id])setTimeout(()=>{e(a,c)},100);else{let d={name:c.name.get(),model_type:c._info.model_type.get(),_server_id:c._server_id,version:'\u2014',last_modified:'\u2014',owner:b.user.username};if('Path'===c._info.model_type.get()){if(0!=c._info.remaining.get()){let a=(c._info.to_upload.get()-c._info.remaining.get())/c._info.to_upload.get();d.upload_pecent=100*a}}else if('BIM Project'===c._info.model_type.get()&&c._info.state)switch(c._info.state.num.get()){case 0:d.upload_pecent=10;break;case 1:d.upload_pecent=18;break;case 2:d.upload_pecent=36;break;case 3:d.upload_pecent=54;break;case 4:d.upload_pecent=72;break;case 5:d.upload_pecent=90;break;case 6:break;case 7:d.upload_pecent=100,d.error=!0;}a.resolve(d)}};return e(d,c),d.promise},d=[];for(var e=0;e<b.curr_dir.length;e++){let a=b.curr_dir[e];d.push(c(a))}return a.all(d)}),this.getFolderJson=(a)=>this.init().then(()=>this.getFolderJson_rec(a,this.model)),this.FE_selected_drag=[],this.FE_init_dir_drag=0,this.FE_fspath_drag=[],this.FE_visited_scope=[],this.addScopeVisted=(a)=>{for(var b=0;b<this.FE_visited_scope.length;b++)if(this.FE_visited_scope[b]==a)return;this.FE_visited_scope.push(a)},this.fileSelected=(a)=>{this.lastfileSelected=a,this.lastinspector&&this.lastinspector.set_model(this.lastfileSelected)},this.setlastInspector=(a)=>{this.lastinspector=a},this}]);
angular.module('app.services').factory('goldenLayoutService',['$q','$window','$templateCache','$rootScope','$compile',function(a,b,c,d,e){var f={content:[{type:'row',content:[{isClosable:!1,title:'Folder Explorer',type:'component',width:20,componentName:'SpinalHome',componentState:{template:'sideBar.html',controller:'sideBarCtrl'}},{isClosable:!1,title:'File Explorer',type:'component',componentName:'SpinalHome',componentState:{template:'FileExplorer.html',controller:'FileExplorerCtrl'}},{isClosable:!1,title:'Inspector',type:'component',componentName:'SpinalHome',componentState:{template:'inspector.html',controller:'InspectorCtrl'}}]}]};let g=0,h={};return h.init=()=>{0==g&&(g=new GoldenLayout(f,$('#g-layout')),g.registerComponent('SpinalHome',function(a,b){var f=a.getElement();''==b.template?(f.html(),e(f.contents())(d)):(f.html('<div class="gpannel-content" ng-controller="'+b.controller+'" ng-cloak>'+c.get(b.template)+'</div>'),e(f.contents())(d))}),g.init(),angular.element(b).bind('resize',function(){g.updateSize()}),d.$emit('GoldenLayout_READY'))},h.wait_ready=()=>a(function(a){d.$on('GoldenLayout_READY',()=>{a()})}),h.createChild=(a)=>{g.root.contentItems[0].addChild(a)},h.createDragSource=(a,b)=>{g.createDragSource(a,b)},h}]).factory('layout_uid',function(){let a=0;return{get:()=>{let b=a++;return b}}});
angular.module('app.spinalcom').factory('authService',['$q','ngSpinalCore','config','$http',function(a,b,c,d){let e={},f={username:'',password:''},g=!1;e.save_user=(a,b)=>{f.username=a,f.password=b,window.localStorage.setItem('spinalhome_cfg',btoa(JSON.stringify(f)))},e.get_user=()=>{let a=window.localStorage.getItem('spinalhome_cfg');return a&&(f=JSON.parse(atob(a))),f},e.save_user=(a,b)=>{f.username=a,f.password=b,window.localStorage.setItem('spinalhome_cfg',btoa(JSON.stringify(f)))},e.logout=()=>{''!=f.username&&(e.save_user('',''),location.reload())},e.login=(f,j)=>{let k=a.defer();return d.get('/get_user_id'+'?u='+f+'&p='+j).then(function(a){var d=parseInt(a.data),l=0;if(-1==d){for(k.reject('Login Error: username / password pair not found.'),l=0;l<h.length;l++)h[l].reject();return void(h=[])}for(b.connect('http://'+d+':'+j+'@'+c.spinalhub_url+':'+c.spinalhub_port+'/'),e.save_user(f,j),g=!0,k.resolve(),l=0;l<h.length;l++)h[l].resolve();h=[]},function(){k.reject('Connection Error: Imposible to connect to the server.');for(var a=0;a<h.length;a++)h[a].reject();h=[]}),k.promise},e.is_Connected=()=>g;let h=[];return e.wait_connect=()=>{let b=a.defer();return!0==g?b.resolve():h.push(b),b.promise},e}]);
angular.module('app.sidebar',['jsTree.directive','app.services','app.spinalcom']).controller('sideBarCtrl',['$scope','$rootScope','spinalFileSystem','$mdDialog','$injector',function(a,b,c,d,e){a.injector=e,a.fsdir=[],a.all_dir={};let f=0;d.prompt().title('Input the name of the new folder').placeholder('Folder Name').initialValue('New Folder').required(!0).ok('Ok').cancel('Cancel');a.DnD_callback=(a,b,d,e,f)=>{if(('move_node'===a||'copy_node'===a)&&b.type&&'root'==b.type||'#'==d.id)return!1;if(b.original.model==d.original.model)return!1;if(('move_node'===a||'copy_node'===a)&&f&&f.core){if(confirm('Are you sure you want to move the folder ?')){let h,f=FileSystem._objects[d.original.model],i=c.folderExplorer_dir[b.original.parent],j=FileSystem._objects[i.model];for(var g=0;g<j.length;g++)if(j[g]._ptr.data.value==b.original.model){h=j[g];break}if(!f||!h)return!1;if(f!=j){let a=h.name.get(),b=a,c=0;for(;f.has(a);)a=b+'('+c+')',c++;a!=h.name.get()&&h.name.set(a)}if('move_node'==a||f==j&&'copy_node'==a)for(g=0;g<j.length;g++){let a=j[g];if(a==h){j.splice(g,1),g<e&&e--;break}}return f.insert(e,[h]),!0}return!1}return!0},a.contextMenu=(b)=>{let c=spinalDrive_Env.get_applications('FolderExplorer',b),d=(b,c)=>function(){let d={node:b,model_server_id:b.original.model,scope:a};c.action(d)},e={};for(var f=0;f<c.length;f++){let a=c[f];e[a.name]={label:a.label,icon:a.icon,action:d(b,a)}}return e},a.treeCore={themes:{name:'default-dark'},check_callback:a.DnD_callback};let g=c.subcribe('SPINAL_FS_ONCHANGE',()=>{c.getFolderJson(a.all_dir).then((b)=>{a.fsdir=b.tree,a.all_dir=b.all_dir})});a.$on('$destroy',g),a.select_node=(b,d)=>{console.log('select_node'),console.log(d.node.original.model),f=d.node.original,c.select_node(a.all_dir,d)},a.onChangeNodeTree=(b,d)=>{console.log('onChangeNodeTree'),console.log(d),c.onChangeNodeTree(a.all_dir,d)},a.onbdlclick=(b)=>{var d=$(b.target).closest('li');console.log('onbdlclick : '+d[0].id),c.onbdlclick(a.all_dir,d[0].id)},c.init(),c.getFolderJson(a.all_dir).then((b)=>{console.log(b),a.fsdir=b.tree,a.all_dir=b.all_dir})}]);
angular.module('app.controllers').controller('mainCtrl',['$scope','$routeParams','goldenLayoutService','spinalModelDictionary',function(a,b,c){a.my_test='truc',c.init()}]);
angular.module('app.FileExplorer',['jsTree.directive','app.services','app.spinalcom','ngMaterial','md.data.table']).controller('FileExplorerCtrl',['$scope','$rootScope','spinalFileSystem','$mdDialog','authService','$compile','$injector','layout_uid',function(a,b,c,d,e,f,g,h){function i(){return c.getFolderFiles(a).then((b)=>{let c=0,d=(b,c)=>b.findIndex((b)=>a.directory[c]._server_id==b._server_id);for(;c<a.directory.length;)-1==d(b,c)?(a.directory.splice(c,1),c=0):c++;let e=!1;for(c=0;c<b.length;c++){e=!1;for(var f=0;f<a.directory.length;f++)if(a.directory[f]._server_id===b[c]._server_id){a.directory[f].name=b[c].name,a.directory[f].model_type=b[c].model_type,a.directory[f].owner=b[c].owner,a.directory[f].last_modified=b[c].last_modified,a.directory[f].version=b[c].version,a.directory[f].upload_pecent=b[c].upload_pecent?b[c].upload_pecent:b[c].upload_pecent,e=!0;break}!1==e&&a.directory.splice(f,0,b[c])}})}a.injector=g,a.uid=h.get(),a.curr_dir=0,a.lastSelected=0,a.fs_path=[];d.prompt().title('Input the name of the new folder').placeholder('Folder Name').initialValue('New Folder').required(!0).ok('Ok').cancel('Cancel');a.onFocus=()=>{c.FileExplorer_focus(a)},a.onFocus(),a.directory=[],a.user=e.get_user(),a.fsmoveToParent=(b)=>{let c=a.fs_path.indexOf(b);a.fs_path.splice(c+1);let d=FileSystem._objects[b._server_id];d&&(d instanceof File?d.load((b)=>{b&&a.change_curr_dir(b,a.fs_path)}):d instanceof Directory&&a.change_curr_dir(d,a.fs_path))},a.getIcon=(a)=>spinalDrive_Env.context_file_exp_app_icon[a]?spinalDrive_Env.context_file_exp_app_icon[a]:spinalDrive_Env.context_file_exp_app_icon.default,a.selectFile=(b,c)=>{if(!1==b.ctrlKey){for(var d=0;d<a.directory.length;d++)a.directory[d].selected=!1,a.directory[d].over=!1,a.directory[d].selectdrop=!1;console.log(c)}c.selected=!c.selected},a.ondblclick=(b)=>{if(console.log('dbl click'),console.log(b),'Directory'==b.model_type){let c=FileSystem._objects[b._server_id];c&&c.load((c)=>{c&&(a.fs_path.push({name:b.name,_server_id:b._server_id}),a.change_curr_dir(c,a.fs_path))})}},a.change_curr_dir=(b,c)=>{a.curr_dir=b,a.fs_path=c,i()};let j=c.subcribe('SPINAL_FS_ONCHANGE',i);a.$on('$destroy',j),a.enterTarget=0,a.getNbSelectedIcon=(b)=>{console.log(b);let c=0;for(var d=0;d<a.directory.length;d++)a.directory[d].selected&&c++;if(1==c)return a.getIcon(b);return 9>=c?'filter_'+c:'filter_9_plus'},a.dragCfg={dragstart:(d,e)=>{if(console.log('dragstart'),console.log(d),!1==e.selected&&!0!=d.ctrlKey)for(let b=0;b<a.directory.length;b++)a.directory[b].selected=!1;e.selected=!0;let g=$('<div id="drag-extra" class="fs-drag-item"><ng-md-icon icon="'+a.getNbSelectedIcon(e.model_type)+'" style="fill: white;height: 24px;" class="md-avatar-icon"></ng-md-icon><div style="float: left;margin-left: 20px;width: -webkit-fill-available;overflow: hidden;text-overflow: ellipsis;"><span style="white-space: nowrap;">'+e.name+'</span></div></div>');f(g[0])(b),g.appendTo('body'),d.dataTransfer.setDragImage(g[0],0,0),c.FE_selected_drag=[];for(let b=0;b<a.directory.length;b++)!0==a.directory[b].selected&&(a.directory[b].selectdrop=!0,c.FE_selected_drag.push(a.directory[b]));return c.FE_init_dir_drag=a.curr_dir,c.FE_fspath_drag=a.fs_path,c.addScopeVisted(a),b.current_scope_drag=a,a.$apply(),!1},dragend:(b,d)=>{console.log('dragend'),console.log(d);for(let c=0;c<a.directory.length;c++)a.directory[c].selectdrop=!1,a.directory[c].over=!1;a.enterTarget=0,a.dropOnFolder=!1;for(var e=0;e<c.FE_visited_scope.length;e++){let a=c.FE_visited_scope[e];for(var f=0;f<a.directory.length;f++)if(!0==a.directory[f].over){a.directory[f].over=!1;break}a.dropOnFolder=!1,a.$apply()}return c.FE_visited_scope=[],!1},dragenter:(a)=>{a.preventDefault()},dragover:(b,d)=>{if(b.preventDefault(),b.stopPropagation(),console.log('over'),d._server_id==a.enterTarget._server_id)return!1;a.enterTarget=!0==d.selected||'Directory'!=d.model_type?0:d;for(let c=0;c<a.directory.length;c++)a.directory[c].over=!1;a.enterTarget&&(b.dataTransfer.dropEffect='move',b.dataTransfer.effectAllowed='move',d.over=!0),a.dropOnFolder=!1,a.$apply(),c.addScopeVisted(a);for(var e=0;e<c.FE_visited_scope.length;e++){let b=c.FE_visited_scope[e];if(b!=a){for(var f=0;f<b.directory.length;f++)if(!0==b.directory[f].over){b.directory[f].over=!1;break}b.dropOnFolder=!1,b.$apply()}}},drop:(b)=>{b.stopPropagation(),b.preventDefault(),console.log('drop');let d=c.FE_init_dir_drag,e=0,f=0;for(;f<a.directory.length;f++)if(a.directory[f].over){e=a.directory[f];break}if(!e||'Directory'!=e.model_type)return!1;let g=b.target.files;if(g&&0!==g.length||(g=b.dataTransfer?b.dataTransfer.files:b.originalEvent.dataTransfer.files),0<g.length){console.log('folderDropCfg drop Files'),console.log(g);let b=FileSystem._objects[e._server_id];return b&&a.upload_files(g,b),a.dropOnFolder=!1,a.$apply(),!1}if(!e||'Directory'!=e.model_type)return!1;let h=c.FE_selected_drag,i=FileSystem._objects[e._server_id];if(i)for(f=0;f<a.fs_path.length;f++){let b=FileSystem._objects[a.fs_path[f]._server_id];if(b)if(b instanceof File){if(b._ptr.data.value==d._server_id)return!1;}else if(b instanceof Directory&&b._server_id==d._server_id){let b=!1;if(2<=a.fs_path.length){console.log(a.fs_path);for(var j=0;j<h.length;j++)if(h[j]._server_id==FileSystem._objects[a.fs_path[1]._server_id]._server_id){b=!0;break}}if(!1==b)continue;return!1}}for(f=0;f<h.length;f++){let a=FileSystem._objects[h[f]._server_id];a&&d.remove_ref(a)}return i&&i.load((a)=>{for(var b=0;b<h.length;b++){let c=FileSystem._objects[h[b]._server_id];c&&a.push(c)}}),!1}},a.upload_files=(b,c)=>{if(0<b.length)for(var d=0;d<b.length;d++){let e=b[d],f=new Path(e),g=a.get_unused_name(e.name,c),h=c.add_file(e.name,f)}},a.get_unused_name=(b,c,d)=>{let e=!1;for(let a=0;a<c.length;a++)c[a].name.get()==b&&(e=!0);if(!0==e){d?++d:(d=0,b+='('+d+')');let e=/\(\d+\)$/gm;return b=b.replace(e,'('+d+')'),a.get_unused_name(b,c,d)}return b},a.folderDropCfg={drop:(b)=>{b.stopPropagation(),b.preventDefault(),console.log('folderDropCfg drop');var d=b.target.files;if(d&&0!==d.length||(d=b.dataTransfer?b.dataTransfer.files:b.originalEvent.dataTransfer.files),0<d.length){console.log('folderDropCfg drop Files'),console.log(d);let b=a.curr_dir;return console.log(a.directory),a.upload_files(d,b),a.dropOnFolder=!1,a.$apply(),!1}let e=c.FE_init_dir_drag;if(e==a.curr_dir)return!1;let f=c.FE_selected_drag,g=a.curr_dir;if(g){let b;for(b=0;b<a.fs_path.length;b++){let c=FileSystem._objects[a.fs_path[b]._server_id];if(c)if(c instanceof File){if(c._ptr.data.value==e._server_id)return!1;}else if(c instanceof Directory&&c._server_id==e._server_id){let b=!1;if(1<=a.fs_path.length)for(var h=0;h<f.length;h++)if(f[h]._server_id==FileSystem._objects[a.fs_path[1]._server_id]._server_id){b=!0;break}if(!1==b)continue;return!1}}}for(let a,c=0;c<f.length;c++)a=FileSystem._objects[f[c]._server_id],a&&e.remove_ref(a);if(g)for(var j=0;j<f.length;j++){let a=FileSystem._objects[f[j]._server_id];a&&g.push(a)}return a.dropOnFolder=!1,!1},dragover:(b)=>{b.preventDefault(),console.log('folderDropCfg over');for(var d=0;d<a.directory.length;d++)if(!0==a.directory[d].over){a.directory[d].over=!1;break}for(a.enterTarget=0,a.dropOnFolder=!0,c.addScopeVisted(a),d=0;d<c.FE_visited_scope.length;d++){let b=c.FE_visited_scope[d];if(b!=a){for(var e=0;e<b.directory.length;e++)if(!0==b.directory[e].over){b.directory[e].over=!1;break}b.dropOnFolder=!1,b.$apply()}}return a.$apply(),!1},dragenter:(a)=>(a.preventDefault(),!1)},i(),a.context_menu_file=[],a.onrightclick=(b)=>{setTimeout(()=>{$('#fe-menu-'+a.uid+'-'+b).click()})},a.open_context_menu_file=(b,c,d)=>{a.context_menu_file=spinalDrive_Env.get_applications('FileExplorer',{file:d,scope:a}),console.log(a.context_menu_file),console.log(d),b.open(c)},a.context_menu_file_action=(b,c,d)=>{console.log('ACTION'),console.log(b),console.log(c),console.log(d),c.launch_action({evt:b,item:c,file:d,scope:a})},a.context_menu_curr_dir=[],a.open_context_menu_curr_dir=(b,c)=>{a.context_menu_curr_dir=spinalDrive_Env.get_applications('FileExplorerCurrDir',{scope:a,model:a.curr_dir}),console.log(a.context_menu_curr_dir),b.open(c)},a.context_menu_curr_dir_action=(b,c)=>{c.launch_action({evt:b,item:c,model:a.curr_dir,scope:a})}}]);
angular.module('app.controllers').controller('navbarCtrl',['$scope','authService','$location',function(a,b,c){a.username='',a.connected=!1,b.wait_connect().then(()=>{a.username=b.get_user().username,a.connected=!0}),a.logout=()=>{c.path('/login')},a.layouts=[{id:'drag-folder-explorer',name:'Folder Explorer',cfg:{isClosable:!0,title:'Folder Explorer',type:'component',width:20,componentName:'SpinalHome',componentState:{template:'sideBar.html',module:'app.sidebar',controller:'sideBarCtrl'}}},{id:'drag-file-explorer',name:'File Explorer',cfg:{isClosable:!0,title:'File Explorer',type:'component',componentName:'SpinalHome',componentState:{template:'FileExplorer.html',module:'app.FileExplorer',controller:'FileExplorerCtrl'}}},{id:'drag-inspector',name:'Inspector',cfg:{isClosable:!0,title:'Inspector',type:'component',componentName:'SpinalHome',componentState:{template:'inspector.html',controller:'InspectorCtrl'}}}]}]);
angular.module('app.FileExplorer').controller('InspectorCtrl',['$scope','$injector','spinalInspectUID','authService','$mdToast','$interval','spinalFileSystem','$timeout',function(a,b,c,d,e,f,g,h){function i(c,a,b){return c.substring(0,b)==a.substring(0,b)}function j(a){c.tooltip.transition().duration(300).style('opacity',1),c.tooltip.selectAll('table').remove();let b=c.tooltip.append('table');D(b,'Contructor',a.data._constructor),D(b,'Server_id',a.data._server_id);let d=FileSystem._objects[a.data._server_id];if(d)if(d instanceof Lst)D(b,'Length',d.length);else if(d instanceof Str){let a=d.get();D(b,'Data',a),D(b,'Length',d.length);let c='data:image/';if(i(a,c,c.length)){let c=b.append('tr');c.append('td').text('Preview');let d=c.append('td').append('img');d.attr('src',a),d.attr('alt','preview'),d.style('max-height',100),d.style('max-width',100)}}else d instanceof Val?D(b,'Value',d.get()):d instanceof Ptr?(D(b,'Target Ptr',d.data.value),d.load((a)=>{a&&D(b,'Target Contructor',a.constructor.name)})):d instanceof TypedArray&&D(b,'Data',d.get())}function k(){c.tooltip.style('left',d3.event.pageX+'px').style('top',d3.event.pageY+'px')}function l(){c.tooltip.transition().duration(300).style('opacity',1e-6)}a.injector=b,a.fs_path=[];let m,n,o,p,q,r,s=0,t=[],u=50,v=50,w=[],z=500,x={nodefill:{empty:'#fff',ptrClosed:'#f00',objClosed:'#0010f2',lstClosed:'#00ab00',ptrEmptyOrOpen:'#f0a9a9',objEmptyOrOpen:'#87ceeb',lstEmptyOrOpen:'#7fffd4'}},y=(b)=>{let c=spinalDrive_Env.get_applications('Inspector',b),d=[],e=(c)=>function(){let d={model_server_id:b.data._server_id,scope:a};c.action(d)};for(var f=0;f<c.length;f++){let a=c[f];d.push({title:a.label,action:e(a)})}return d},A=(a,b)=>{let c=`M ${a.y} ${a.x}
                C ${(a.y+b.y)/2} ${a.x},
                  ${(a.y+b.y)/2} ${b.x},
                  ${b.y} ${b.x}`;return c},B=()=>{null!=d3.event.transform&&m.attr('transform',d3.event.transform)},C=(a,b)=>{let c=0,d=0;for(;c<a;)d+=2*t[c],++c;return d+=t[a],d*=b,d};angular.element(document).ready(function(){let b=c.get_last_uid(),d=c.elem[b];u=d.width(),v=d.height();let e=d3.select('#'+('spinalinspect_'+b)),g=d3.tree().size([v,u]),h=d3.zoom().scaleExtent([0.1,3]).on('zoom',B);q=function(a){let b,c,d=a.depth+1,e=1;b=0,d-=a.depth,c=-a.x0;for(let c=120;b<c;)b=-n.y0,b=b*e+u/2,b-=C(d,6)/2*e,b<c&&(e-=0.01);b-=C(a.depth,6)*e,c=c*e+v/2,i.transition().duration(z).call(h.transform,d3.zoomIdentity.translate(b,c).scale(e))},e.select('svg').remove();let i=e.append('svg').attr('width',u).attr('height',v).classed('svg-content',!0).call(h);i.on('dblclick.zoom',null);let D=d3.select('#spinalinspect_btn_centerroot_'+b);D.on('click',()=>{n&&q(n)}),r=i.append('text').attr('class','nodeText').attr('x',u/2).attr('y',v/2).attr('text-anchor','middle').attr('alignment-baseline','central').attr('fill','#999'),m=i.append('g');let E=(a)=>{if(a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),a.data.haveChild&&!(a.children||a._children)){let b=FileSystem._objects[a.data._server_id];if(b){if(b instanceof Ptr)return void b.load((b)=>{b.bind(G,!1);let c={};w.push(b),I(b,c,a,a.depth+2,a.depth+1),a.children=[c],a.data.children=a.children,p(a),q(a)});I(b,a,a.parent,a.depth+1,a.depth,a.data.name)}}p(a),q(a)};o=()=>{i.attr('width',u).attr('height',v),r&&r.attr('x',u/2).attr('y',v/2).text('Please Drop file from "File Explorer" here to inspect them.');n&&(n.x0=v/2,n.y0=0,p(n))};let F=(a)=>{q(a)};p=(a)=>{let b=g.size([v,u]),c=b(n),d=c.descendants(),e=c.descendants().slice(1);d.forEach((a)=>{t[a.depth]=t[a.depth]?Math.max(a.data.name.length,t[a.depth]):a.data.name.length}),d.forEach((a)=>{a.y=C(a.depth,6)});let f=m.selectAll('g.node').data(d,(a)=>a.id||(a.id=++s)),h=f.enter().append('g').attr('class','node').attr('transform',()=>'translate('+a.y0+','+a.x0+')').on('mouseover',j).on('mousemove',function(a){k(a)}).on('mouseout',l);h.append('circle').attr('class','nodeCircle').attr('r',1e-6).on('contextmenu',d3.contextMenu(y)).on('click',E),h.append('text').attr('x',(a)=>a.children||a._children?-10:10).attr('dy','.35em').attr('class','nodeText').attr('text-anchor',(a)=>a.children||a._children?'end':'start').text((a)=>a.data.name).attr('fill','#EEE').on('click',F).on('contextmenu',d3.contextMenu(y));var i=h.merge(f);i.transition().duration(z).attr('transform',function(a){return'translate('+a.y+','+a.x+')'}),i.select('circle.nodeCircle').attr('r',8).style('fill',function(a){if(a.data.obj)return a.data.haveChild&&!(a.children||a._children)?x.nodefill.objClosed:a.children&&0<a.children.length?x.nodefill.objEmptyOrOpen:a.children||a._children?x.nodefill.objClosed:x.nodefill.objEmptyOrOpen;return a.data.lst?a.data.haveChild&&!(a.children||a._children)?x.nodefill.lstClosed:a.children&&0<a.children.length?x.nodefill.lstEmptyOrOpen:a.children||a._children?x.nodefill.lstClosed:x.nodefill.lstEmptyOrOpen:a.data.ptr?a.data.haveChild&&!(a.children||a._children)?x.nodefill.ptrClosed:a.children&&0<a.children.length?x.nodefill.ptrEmptyOrOpen:a.children||a._children?x.nodefill.ptrClosed:x.nodefill.ptrEmptyOrOpen:x.nodefill.empty}).attr('cursor','pointer'),i.select('text.nodeText').attr('x',(a)=>a.children?-10:10).attr('text-anchor',(a)=>a.children?'end':'start').text((a)=>a.data.name);let o=f.exit().transition().duration(z).attr('transform',()=>'translate('+a.y+','+a.x+')').remove();o.select('circle').attr('r',0),o.select('text').style('fill-opacity',0);let p=m.selectAll('path.link').data(e,(a)=>a.id),q=p.enter().insert('path','g').attr('class','link').attr('d',()=>{let b={x:a.x0,y:a.y0};return A(b,b)}),r=q.merge(p);r.transition().duration(z).attr('d',(a)=>A(a,a.parent));p.exit().transition().duration(z).attr('d',()=>{let b={x:a.x,y:a.y};return A(b,b)}).remove();d.forEach((a)=>{a.x0=a.x,a.y0=a.y})};let H=f(()=>{(u!=d.width()||v!=d.height())&&(u=d.width(),v=d.height(),o())},600);a.$on('$destroy',function(){f.cancel(H),H=void 0})});let D=(a,b,c)=>{let d=a.append('tr');d.append('td').text(b),d.append('td').text(c)},E=null,F=null,G=()=>{E||(E=h(()=>{E=null,H(n,n.data.name);F||(F=h(()=>{F=null,p(n)},500))},500))},H=(a,b)=>{if(a&&a.data&&a.data._server_id){let c=FileSystem._objects[a.data._server_id];if(c)if(b||(b=a.data.name),a.data._constructor=c.constructor.name,a.data._server_id=c._server_id,c instanceof Val||c instanceof Bool)a.data.name=a.data.name.replace(/ *= [.\-\w]*/g,''),a.data.name+=` = ${c.get()}`;else if(c instanceof Str){let d=c.get();25<d.length&&(d=d.substring(0,25)+'...'),a.data.name=a.data.name.replace(/ *= *"*\w*.*"*/g,''),a.data.data=`${b} = \"${c.get()}\"`,a.data.name+=` = \"${d}\"`}else if(c instanceof TypedArray)a.data.name=a.data.name.replace(/ *= [0-9.e\-]*/g,''),a.data.name+=` = ${c._size}`;else if(c instanceof Ptr){a.data.ptr=c.data.value,a.data.name=a.data.name.replace(/ *= *"*\w*"*/g,''),a.data.name+=` = \"${c.data.value}\"`,a.data.haveChild=!0;let b=a.children||a._children;if(!b)return;c.load((a)=>{b[0].data._server_id==a._server_id&&H(b[0])})}else if(c instanceof Lst){a.data.name=a.data.name.replace(/\[[0-9]*\]/g,''),a.data.name+=`[${c.length}]`,a.data.lst=!0,a.data.haveChild=0!==c.length;let b=a.children||a._children;if(!b)return;for(let d=0;d<c.length;d++)if(b[d]&&b[d].data&&b[d].data._server_id&&b[d].data._server_id===c[d]._server_id)H(b[d]);else{let e=d,f=-1;for(;e<b.length;e++)if(b[e]&&b[e].data&&b[e].data._server_id&&b[e].data._server_id===c[d]._server_id){f=e;break}if(-1!=f){let a=b.splice(e,1);0<a.length&&b.splice(d,0,a[0])}else{let e={};I(c[d],e,a,a.depth+1,a.depth+1),b.splice(d,0,e)}}c.length<b.length&&b.splice(c.length,b.length-c.length),0===b.length&&(a.children=a._children=a.data.children=a.data._children=null)}else if(c instanceof Model){a.data.obj=!0,a.data.name=a.data.name.replace(/{[0-9]*}/g,''),a.data.name+=`{${c._attribute_names.length}}`;let b=0,d=a.children||a._children;if(a.data.haveChild=0!==c._attribute_names.length,!d)return;for(b=0;b<d.length;b++)d[b].data.used=!1;for(b=0;b<c._attribute_names.length;b++){let e=c[c._attribute_names[b]],f=!1;for(let a,b=0;b<d.length;b++)a=d[b],a&&a.data&&a.data._server_id&&e._server_id===a.data._server_id&&(a.data.used=!0,H(a),f=!0);if(!1==f){let e={};I(c[b],e,a,a.depth+1,a.depth+1),e.data.used=!0,d.push(e)}}for(b=0;b<d.length;){if(!d[b].data.used){d.splice(b,1);continue}b++}}}};a.onFocus=()=>{g.setlastInspector(a)},a.set_model=(b)=>{for(var c=0;c<w.length;c++)w[c].unbind(G);w=[],a.model=g.lastfileSelected;let d=FileSystem._objects[b];d&&(w.push(d),d.bind(G),a.new_tree(d))};let I=(a,b,c,d=1,e=0,f=a.constructor.name)=>{if(b.parent=c,b.depth=e,b.data={},b.data.name=f,b.data._constructor=a.constructor.name,b.data._server_id=a._server_id,++e,a instanceof Lst){if(b.data.name=b.data.name.replace(/\[[0-9]*\]/g,''),b.data.name+=`[${a.length}]`,b.data.lst=!0,0==a.length)return void(b.data.haveChild=!1);if(b.data.haveChild=!0,e>d)return;b.children=[],b.data.children=b.children;for(let c,f=0;f<a.length;f++)c={},I(a[f],c,b,d,e),b.children.push(c)}else if(a instanceof Val||a instanceof Bool)b.data.name+=` = ${a.get()}`;else if(a instanceof Str){let c=a.get();25<c.length&&(c=c.substring(0,25)+'...'),b.data.data=`${f} = \"${a.get()}\"`,b.data.name+=` = \"${c}\"`}else if(a instanceof Ptr)b.data.haveChild=!0,b.data.ptr=a.data.value,b.data.name+=` = \"${a.data.value}\"`;else if(a instanceof TypedArray)b.data.name+=` = ${a._size}`;else if(a instanceof Model){if(b.data.obj=!0,b.data.name=b.data.name.replace(/{[0-9]*}/g,''),b.data.name+=`{${a._attribute_names.length}}`,e>d)return void(0<a._attribute_names.length&&(b.data.haveChild=!0));b.children=[],b.data.children=b.children;for(var g=0;g<a._attribute_names.length;g++){let c={};I(a[a._attribute_names[g]],c,b,d,e,a._attribute_names[g]),b.children.push(c)}}},J=(a,b,c=1,d=0,e=a.constructor.name)=>{if(b.name=e,b._constructor=a.constructor.name,b._server_id=a._server_id,++d,a instanceof Lst){if(b.name+=`[${a.length}]`,b.lst=!0,0==a.length)return;if(d>c)return;b.haveChild=!0,b.children=[];for(let b,e=0;e<a.length;e++)b={},J(a[e],b,c,d),children.push(b)}else if(a instanceof Val||a instanceof Bool)b.name+=` = ${a.get()}`;else if(a instanceof Str){let c=a.get();25<c.length&&(c=c.substring(0,25)+'...'),b.data=`${e} = \"${a.get()}\"`,b.name+=` = \"${c}\"`}else if(a instanceof Ptr)b.haveChild=!0,b.ptr=a.data.value,b.name+=` = \"${a.data.value}\"`;else if(a instanceof TypedArray)b.name+=` = ${a._size}`;else if(a instanceof Model){if(b.obj=!0,b.name+=`{${a._attribute_names.length}}`,d>c)return void(0<a._attribute_names.length&&(b.haveChild=!0));b.children=[];for(var f=0;f<a._attribute_names.length;f++){let e={};J(a[a._attribute_names[f]],e,c,d,a._attribute_names[f]),b.children.push(e)}}};a.new_tree=(a)=>{if(console.log('new tree'),console.log(a),!!a){r&&r.remove(),r=null;let b={};J(a,b),n=d3.hierarchy(b,function(a){return a.children}),o&&(o(),q(n))}},a.folderDropCfg={drop:(b)=>{b.stopPropagation(),b.preventDefault();let c=g.FE_selected_drag;return c&&c[0]&&(a.fs_path=Array.from(g.FE_fspath_drag),a.fs_path.push({name:c[0].name,_server_id:c[0]._server_id}),a.set_model(c[0]._server_id)),!1},dragover:(a)=>(a.preventDefault(),!1),dragenter:(a)=>(a.preventDefault(),!1)},g.setlastInspector(a),a.set_model(g.lastfileSelected)}]);
angular.module('app.controllers').controller('loginCtrl',['$scope','authService','$mdToast','$location',function(a,b,c,d){let e=c.simple().hideDelay(3e3),f=b.get_user();b.logout(),a.conf={email:'',password:''},a.ConnectBtn=()=>{b.login(a.conf.email,a.conf.password).then(()=>{d.path('/home')},(a)=>{e.textContent(a),c.show(e)})}}]);

//# sourceMappingURL=app.compile.min.js.map